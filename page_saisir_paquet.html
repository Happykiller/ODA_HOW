<!DOCTYPE html> 
<html>
  <head>
    <!--META-->
    <meta charset="utf-8">
    <title>paquet</title>
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

    <!--CSS-->
    <link rel="icon" type="image/png" href="img/faviconsdsd.png" />
    <link rel="stylesheet" href="API/css/themes/default/jquery.mobile.min.css" />
    <link rel="stylesheet" href="API/js/DataTables/css/jquery.dataTables.min.css"/>

    <!--JS-->
    <script type="text/javascript" src="API/js/Jquery/jquery.min.js"></script>
    <script type="text/javascript" src="API/js/JqueryMobile/jquery.mobile.min.js"></script>
    <script type="text/javascript" src="API/js/DataTables/js/jquery.dataTables.min.js"></script> 
    <script type="text/javascript" src="API/js/functionsLib.js"></script>
    
    <script type="text/javascript" src="http://wowjs.zamimg.com/widgets/power.js?1389797934"></script>

    <script type="text/javascript">
    ///////////////////
    //BLOCK VARIABLE GLOBAL
    ///////////////////
    var id_page = 22;
    var wowhead_tooltips = { "colorlinks": true, "iconizelinks": true, "renamelinks": true };

    ///////////////////
    //BLOCK FONCTIONS EVENEMENTS
    ///////////////////

    //Fin chargement page
    $.functionsLib.ready = function(){
        try {
            $('#content_reste').css("width", window.innerWidth-510);
            chargerPaquet();
        } catch (er) {
            $.functionsLib.log(0, "ERROR(OnLoad):" + er.message);
        }
    };

    ///////////////////
    //BLOCK FONCTIONS METIER
    ///////////////////
    /**
     * chargerPaquet
     */
    function chargerPaquet(){
        try {
            var strhtml = "<IMG SRC=\"API/img/loading.gif\" ALT=\"Chargement\" TITLE=\"Chargement\">";
            $('#div_paquet').html(strhtml);
            var tabSetting = { functionRetour : retourPaquet};
            var tabInput = { code_user : $.functionsLib.getUserInfo().code_user };
            $.functionsLib.callRest(g_urlHostServer+"phpsql/getPaquet.php", tabSetting, tabInput);            
        } catch (er) {
            $.functionsLib.log(0, "ERROR(chargerPaquet):" + er.message);
        }
    }
    
    /**
     * chargerCars
     */
    function chargerCars(){
        try {
            var strhtml = "<IMG SRC=\"API/img/loading.gif\" ALT=\"Chargement\" TITLE=\"Chargement\">";
            $('#div_inventaire').html(strhtml);
            var tabSetting = { functionRetour : retourCards};
            var tabInput = { type : "", code_user : $.functionsLib.getUserInfo().code_user };
            $.functionsLib.callRest(g_urlHostServer+"phpsql/getCards.php", tabSetting, tabInput);            
        } catch (er) {
            $.functionsLib.log(0, "ERROR(chargerCars):" + er.message);
        }
    }
    
    /**
     * choisir
     */
    function choisir(p_id_card, p_gold){
        try {
            var strhtml = "<IMG SRC=\"API/img/loading.gif\" ALT=\"Chargement\" TITLE=\"Chargement\">";
            $('#div_paquet').html(strhtml);
            var tabInput = { code_user : $.functionsLib.getUserInfo().code_user, id_card : p_id_card, gold : p_gold };
            var json_retour = $.functionsLib.callRest(g_urlHostServer+"phpsql/addPaquet.php", {}, tabInput);
            if(json_retour["strErreur"] == ""){
                $.functionsLib.notification("Selection r&eacute;ussi.", $.functionsLib.oda_msg_color.SUCCES); 
                if(json_retour["data"]["retour"]["full"]=="true"){
                     $('#div_inventaire').html("Plus d'ajout possible.").trigger('create');
                }
                chargerPaquet();
            }else{
                $.functionsLib.notification("Aie erreur!", $.functionsLib.oda_msg_color.ERROR);
            }            
        } catch (er) {
            $.functionsLib.log(0, "ERROR(choisir):" + er.message);
        }
    }
    
    /**
     * retirer
     */
    function retirer(p_nb_avant, p_id){
        try {
            var tabInput = { id: p_id, code_user : $.functionsLib.getUserInfo().code_user };
            var json_retour = $.functionsLib.callRest(g_urlHostServer+"phpsql/removePaquet.php", {}, tabInput);
            if(json_retour["strErreur"] == ""){
                $.functionsLib.notification("Bravo", $.functionsLib.oda_msg_color.INFO);
                if($('#div_inventaire').html()=="Plus d'ajout possible."){
                     chargerCars();
                }
                chargerPaquet();
            }else{
                $.functionsLib.notification("Aie erreur!", $.functionsLib.oda_msg_color.ERROR);
            }             
        } catch (er) {
            $.functionsLib.log(0, "ERROR(retirer):" + er.message);
        }
    }
    
    /**
     * valider
     */
    function valider(p_id_paquet, p_id_card){
        try {
            var strhtml = "<IMG SRC=\"API/img/loading.gif\" ALT=\"Chargement\" TITLE=\"Chargement\">";
            $('#div_paquet').html(strhtml);
            var tabInput = { code_user : $.functionsLib.getUserInfo().code_user };
            var json_retour = $.functionsLib.callRest(g_urlHostServer+"phpsql/validerPaquet.php", {}, tabInput);
            if(json_retour["strErreur"] == ""){
                $.functionsLib.notification("Paquet bien int&eacute;gr&eacute;. ("+json_retour["data"]["nbDez"]+" carte(s) desanchant&eacute;e(s))", $.functionsLib.oda_msg_color.INFO); 
                chargerPaquet();
                chargerCars();
            }else{
                $.functionsLib.notification("Aie erreur!", $.functionsLib.oda_msg_color.ERROR);
            }            
        } catch (er) {
            $.functionsLib.log(0, "ERROR(valider):" + er.message);
        }
    }

    ///////////////////
    //BLOCK FONCTIONS AFFICHAGE
    ///////////////////
    /**
     * retourCards
     * 
     * @param {array} p_retour
     */
    function retourCards(json_retour){
        try {
            if(json_retour["strErreur"] == ""){
                var strhtml = '<table cellpadding="0" cellspacing="0" border="0" class="display" id="table_cards"></table></br></br>';
                $('#div_inventaire').html(strhtml).trigger('create');

                var objDataTable = $.functionsLib.objDataTableFromJsonArray(json_retour["data"]["cartes"]["data"]);
                var oTable = $('#table_cards').dataTable( {
                    "aaData": objDataTable.data,
                    "aaSorting": [[0,'asc']],
                    "aoColumns": [
                        { sTitle: "Nom", sClass: "left"  },
                        { sTitle: "Mana", sClass: "center", sWidth: "30px" },
                        { sTitle: "Action", sClass: "left", sWidth: "30px" }
                    ],
                   aoColumnDefs: [
                        {//Nom
                            mRender: function ( data, type, row ) {
                                var strHtml = '<a href="http://www.wowhead.com/hearthstone/card='+row[4]+'" style="color: '+colorCard[row[6]]+';text-decoration: none">'+row[3]+'</a>';
                                return strHtml;
                            },
                            aTargets: [ 0 ]
                        },
                        {//Mana
                            mRender: function ( data, type, row ) {
                                var strHtml = String(row[9]);
                                return strHtml;
                            },
                            aTargets: [ 1 ]
                        },
                        {//Ajouter
                            mRender: function ( data, type, row ) {
                                var strHtml = '<a href="javascript:choisir('+row[0]+',0)" data-role="button" data-icon="plus" data-iconpos="notext" data-inline="true" id="bt_card_'+row[0]+'_1">Ajouter</a>';
                                strHtml += '<a href="javascript:choisir('+row[0]+',1)" data-role="button" data-icon="plus" data-iconpos="notext" data-theme="b" data-inline="true" id="bt_card_'+row[0]+'_2">Ajouter dor&eacute;</a>';
                                return strHtml;
                            },
                            aTargets: [ 2 ]
                        }
                    ],
                    "fnDrawCallback": function( oSettings ) {
                        $('#table_cards').trigger('create');
                    } 
                });
            } else{
                $('#div_inventaire').html(json_retour["strErreur"]).trigger("create");
            }
        } catch (er) {
            $.functionsLib.log(0, "ERROR(retourCards):" + er.message);
        }
    }
    
    /**
     * retourPaquet
     * 
     * @param {array} p_retour
     */
    function retourPaquet(json_retour){
        try {
            if(json_retour["strErreur"] == ""){
                var nb_carte = parseInt(json_retour["data"]["nbInPaquet"]);
                if($('#div_inventaire').html()==""){
                     chargerCars();
                }
                
                if(nb_carte == 5){
                    $('#div_valider').html('<a href="javascript:valider()" data-role="button" data-icon="check" id="bt_valider">Valider &amp; Ajouter dans ma collection</a>').trigger('create');
                }else{
                    $('#div_valider').html('&nbsp').trigger('create');
                }
                
                var strhtml = '<table cellpadding="0" cellspacing="0" border="0" class="display" id="table_paquet"></table></br></br>';
                $('#div_paquet').html(strhtml).trigger('create');

                var objDataTable = $.functionsLib.objDataTableFromJsonArray(json_retour["data"]["paquet"]["data"]);
                
                var oTable = $('#table_paquet').dataTable( {
                    "sPaginationType": "full_numbers",
                    "aaData": objDataTable.data,
                    "aaSorting": [[0, 'asc']],
                    "aoColumns": [
                        { sTitle: "Nom", sClass: "left"  },
                        { sTitle: "Nombre", sClass: "center", sWidth: "30px" },
                        { sTitle: "Mana", sClass: "center", sWidth: "30px" },
                        { sTitle: "Action", sClass: "left", sWidth: "30px" }
                    ],
                   aoColumnDefs: [
                        {//Nom
                            mRender: function ( data, type, row ) {
                                var dore = "";
                                if(row[objDataTable.entete["gold"]] == "1"){
                                    dore = "&amp;premium";
                                }
                                var strHtml = '<a href="http://www.wowhead.com/hearthstone/card='+row[objDataTable.entete["id_link"]]+dore+'" style="color: '+colorCard[row[objDataTable.entete["qualite"]]]+';text-decoration: none">'+row[objDataTable.entete["nom"]]+'</a>';
                                return strHtml;
                            },
                            aTargets: [ 0 ]
                        },
                        {//Nombre
                            mRender: function ( data, type, row ) {
                                var strHtml = row[objDataTable.entete["nb"]];
                                return strHtml;
                            },
                            aTargets: [ 1 ]
                        },
                        {//Mana
                            mRender: function ( data, type, row ) {
                                var strHtml = row[objDataTable.entete["cout"]];
                                return strHtml;
                            },
                            aTargets: [ 2 ]
                        },
                        {//Ajouter
                            mRender: function ( data, type, row ) {
                                var theme = "a";
                                if(row[objDataTable.entete["gold"]] == "1"){
                                    theme = "b";
                                }
                                var strHtml = '<a href="javascript:retirer('+row[objDataTable.entete["nb"]]+','+row[objDataTable.entete["max_id_collec"]]+')" data-role="button" data-icon="delete" data-theme="'+theme+'" data-iconpos="notext" data-inline="true" id="bt_remove_card_'+row[objDataTable.entete["nom"]]+'">Dez</a>';
                                return strHtml;
                            },
                            aTargets: [ 3 ]
                        }
                    ],
                    "fnDrawCallback": function( oSettings ) {
                        $('#table_paquet').trigger('create');
                    }  
                });
            } else{
                $('#div_paquet').html(json_retour["strErreur"]).trigger("create");
            }
        } catch (er) {
            $.functionsLib.log(0, "ERROR(retourPaquet):" + er.message);
        }
    }
</script>

<style>
/* default styles here for older browsers. 
   I tend to go for a 600px - 960px width max but using percentages
*/
/* Stack all blocks to start */
.oda-block-a, 
.oda-block-b { 
    width: 100%; 
    float:none; 
} 
@media only screen and (min-width:960px){
    /* styles for browsers larger than 960px; */
    .oda-block-a{ 
        float:left; 
        width:50%; 
    }
    .oda-block-b{ 
        float:right; 
        width:50%; 
    }
}
@media only screen and (min-width:1024px){
    /* styles for browsers larger than 1440px; */
    .oda-block-a{ 
        float:left; 
        width:40%; 
    }
    .oda-block-b{ 
        float:right; 
        width:60%; 
    }
}
@media only screen and (min-width:1600px){
    /* for sumo sized (mac) screens */
    .oda-block-a{ 
        float:left; 
        width:30%; 
    }
    .oda-block-b{ 
        float:right; 
        width:70%; 
    }
}

//mettre en gris la ligne survolé
tr.highlight td{background-color:Silver !important;}
</style>

</head>
<body>

    <!-- page -->
    <div data-role="page" data-title="Titre">

        <!-- /panel -->
        <div data-role="panel" id="mypanel" data-display="overlay" data-position="left">

        </div>
        <!-- /panel -->

        <!-- header -->
        <div data-role="header" data-position="fixed">
            <a href="#mypanel" data-role="button" data-icon="home" data-iconpos="notext">home</a>
            <h1 id="id_titre">titre</h1>
            <a href="javascript:window.location = ('./api_page_contact.html?mili='+$.functionsLib.getMilise());" data-role="button" data-icon="info" data-iconpos="notext">Contact</a>
        </div>
        <!-- /header -->
        
        <!-- navbar -->
        <!-- /navbar -->

        <!-- content -->
        <div data-role="content" id="main_content">
            
            <div class="oda-block-a">
                <!-- incinventaire -->
                <div data-role="collapsible" data-collapsed="false" data-mini="true" style="width: 99%;">
                    <h3>L'inventaire</h3>
                    <div id="div_inventaire"></div>
                </div>
                <!-- /incinventaire -->
            </div>

            <div class="oda-block-b">
                <!-- collection -->
                <div data-role="collapsible" data-collapsed="false" data-mini="true" style="width: 99%;">
                    <h3>Votre paquet</h3>
                    <div id="div_paquet"></div>
                    <div id="div_valider"></div>
                </div>
                <!-- /collection -->
            </div>
                  
        </div>
        <!-- /content -->

        <!-- footer -->
        <div data-role="footer" data-position="fixed">
            <a data-role="button" data-icon="search" data-iconpos="notext" class="ui-btn-left" href="javascript:window.location = ('./api_page_faq.html?mili='+$.functionsLib.getMilise());">FAQ</a>
            <h1 id="id_affichageUser">User</h1>
            <a data-role="button" data-icon="delete" data-iconpos="notext" class="ui-btn-right" href="javascript:window.location = ('./api_page_sortie.html?mili='+$.functionsLib.getMilise());">Logout</a>
        </div>
        <!-- /footer -->

    </div>
    <!-- /page -->
</body>
</html>